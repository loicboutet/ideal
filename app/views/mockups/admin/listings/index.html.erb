<% content_for :title, "Annonces - Administration - Idéal Reprise" %>

<div class="space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">Annonces</h1>
      <p class="text-gray-600 mt-1">Gestion de toutes les annonces</p>
    </div>
    <%= link_to mockups_admin_listings_pending_path, class: "px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition" do %>
      <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      En attente (18)
    <% end %>
  </div>

  <!-- Filters & Sort -->
  <div class="bg-white rounded-xl shadow-sm p-4 border border-gray-200">
    <div class="grid grid-cols-1 sm:grid-cols-5 gap-4">
      <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-admin-500">
        <option>Tous les statuts</option>
        <option>Brouillon</option>
        <option>En attente</option>
        <option>Validée</option>
        <option>Rejetée</option>
        <option>Retirée</option>
      </select>
      <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-admin-500">
        <option>Tous les types de deal</option>
        <option>Deal Direct</option>
        <option>Mandat Idéal Reprise</option>
        <option>Mandat Partenaire</option>
      </select>
      <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-admin-500">
        <option>Période: 30 derniers jours</option>
        <option>7 derniers jours</option>
        <option>Ce mois</option>
        <option>3 mois</option>
        <option>6 mois</option>
        <option>Tout</option>
      </select>
      <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-admin-500">
        <option>Tri: Plus récent</option>
        <option>Plus ancien</option>
        <option>Plus de vues</option>
        <option>Plus de favoris</option>
        <option>CA croissant</option>
        <option>CA décroissant</option>
      </select>
      <button class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
        Réinitialiser
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 sm:grid-cols-5 gap-4">
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
      <div class="text-sm text-gray-600">Total</div>
      <div class="text-2xl font-bold text-gray-900">327</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
      <div class="text-sm text-gray-600">Vues</div>
      <div class="text-2xl font-bold text-gray-900">12,847</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
      <div class="text-sm text-gray-600">Favoris</div>
      <div class="text-2xl font-bold text-gray-900">1,234</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
      <div class="text-sm text-gray-600">Réservations</div>
      <div class="text-2xl font-bold text-gray-900">142</div>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
      <div class="text-sm text-gray-600">Abandons</div>
      <div class="text-2xl font-bold text-red-600">87</div>
    </div>
  </div>

  <!-- Listings Table -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200" id="listings-table">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition" data-sort="name">
              <div class="flex items-center gap-2">
                Annonce
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                </svg>
              </div>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition" data-sort="type">
              <div class="flex items-center gap-2">
                Type Deal
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                </svg>
              </div>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition" data-sort="sector">
              <div class="flex items-center gap-2">
                Secteur
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                </svg>
              </div>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition" data-sort="views">
              <div class="flex items-center gap-2">
                Vues
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                </svg>
              </div>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition" data-sort="favorites">
              <div class="flex items-center gap-2">
                Favoris
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                </svg>
              </div>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition" data-sort="reservations">
              <div class="flex items-center gap-2">
                Résa
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                </svg>
              </div>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition" data-sort="abandons">
              <div class="flex items-center gap-2">
                Abandons
                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
                </svg>
              </div>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% [
            {id: 1, name: 'Boulangerie artisanale', type: 'Direct', sector: 'Commerce', views: 342, favorites: 12, reservations: 3, abandons: 1, status: 'active'},
            {id: 2, name: 'Restaurant italien', type: 'Mandat Idéal', sector: 'Restauration', views: 289, favorites: 8, reservations: 2, abandons: 0, status: 'active'},
            {id: 3, name: 'Garage automobile', type: 'Mandat Partenaire', sector: 'Services', views: 156, favorites: 5, reservations: 1, abandons: 2, status: 'reserved'},
            {id: 4, name: 'Salon de coiffure', type: 'Direct', sector: 'Services', views: 234, favorites: 15, reservations: 4, abandons: 3, status: 'active'}
          ].each do |listing| %>
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4">
                <div class="font-medium text-gray-900"><%= listing[:name] %></div>
                <div class="text-xs text-gray-500">ID: #<%= listing[:id] %></div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <% case listing[:type] %>
                <% when 'Direct' %>
                  <span class="px-2 py-1 text-xs rounded-full bg-admin-100 text-admin-700">Direct</span>
                <% when 'Mandat Idéal' %>
                  <span class="px-2 py-1 text-xs rounded-full bg-admin-100 text-admin-700">Mandat Idéal</span>
                <% when 'Mandat Partenaire' %>
                  <span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-700">Mandat Partenaire</span>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= listing[:sector] %></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><%= listing[:views] %></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><%= listing[:favorites] %></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><%= listing[:reservations] %></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm <%= listing[:abandons] > 0 ? 'text-red-600 font-medium' : 'text-gray-500' %>">
                <%= listing[:abandons] %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <% if listing[:status] == 'active' %>
                  <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Active</span>
                <% else %>
                  <span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800">Réservée</span>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <%= link_to mockups_admin_listing_path(listing[:id]), class: "text-admin-600 hover:text-admin-800" do %>
                  Voir →
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Table sorting functionality
document.addEventListener('DOMContentLoaded', function() {
  const table = document.getElementById('listings-table');
  if (!table) return;
  
  const headers = table.querySelectorAll('th[data-sort]');
  const tbody = table.querySelector('tbody');
  let currentSort = { column: null, direction: 'asc' };
  
  headers.forEach(header => {
    header.addEventListener('click', function() {
      const column = this.dataset.sort;
      const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
      
      sortTable(column, direction);
      updateSortIcons(this, direction);
      
      currentSort = { column, direction };
    });
  });
  
  function sortTable(column, direction) {
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    const sortedRows = rows.sort((a, b) => {
      let aValue, bValue;
      
      switch(column) {
        case 'name':
          aValue = a.querySelector('td:nth-child(1) .font-medium').textContent.trim();
          bValue = b.querySelector('td:nth-child(1) .font-medium').textContent.trim();
          return direction === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
          
        case 'type':
          aValue = a.querySelector('td:nth-child(2) span').textContent.trim();
          bValue = b.querySelector('td:nth-child(2) span').textContent.trim();
          return direction === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
          
        case 'sector':
          aValue = a.querySelector('td:nth-child(3)').textContent.trim();
          bValue = b.querySelector('td:nth-child(3)').textContent.trim();
          return direction === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
          
        case 'views':
        case 'favorites':
        case 'reservations':
        case 'abandons':
          const colIndex = { views: 4, favorites: 5, reservations: 6, abandons: 7 }[column];
          aValue = parseInt(a.querySelector(`td:nth-child(${colIndex})`).textContent.trim());
          bValue = parseInt(b.querySelector(`td:nth-child(${colIndex})`).textContent.trim());
          return direction === 'asc' ? aValue - bValue : bValue - aValue;
      }
    });
    
    tbody.innerHTML = '';
    sortedRows.forEach(row => tbody.appendChild(row));
  }
  
  function updateSortIcons(activeHeader, direction) {
    // Reset all icons
    headers.forEach(h => {
      const svg = h.querySelector('svg');
      if (svg) {
        svg.classList.remove('text-admin-600');
        svg.classList.add('text-gray-400');
      }
    });
    
    // Highlight active column
    const activeSvg = activeHeader.querySelector('svg');
    if (activeSvg) {
      activeSvg.classList.remove('text-gray-400');
      activeSvg.classList.add('text-admin-600');
      
      // Rotate icon based on direction
      if (direction === 'desc') {
        activeSvg.style.transform = 'scaleY(-1)';
      } else {
        activeSvg.style.transform = 'scaleY(1)';
      }
    }
  }
});
</script>
