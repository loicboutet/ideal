<% content_for :title, "Paiement - #{@selected_plan[:name]} - Idéal Reprise" %>

<div class="min-h-screen bg-gray-50 py-12">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Back Link -->
    <div class="mb-6">
      <%= link_to checkout_select_plan_path, class: "inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 transition" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Retour aux plans
      <% end %>
    </div>

    <div class="lg:grid lg:grid-cols-5 lg:gap-8">
      <!-- Order Summary -->
      <div class="lg:col-span-2 mb-8 lg:mb-0">
        <div class="bg-white rounded-xl shadow-sm p-6 sticky top-8">
          <h2 class="text-lg font-bold text-gray-900 mb-4">Récapitulatif</h2>
          
          <div class="border border-gray-200 rounded-lg p-4 mb-4">
            <h3 class="font-semibold text-gray-900 mb-2"><%= @selected_plan[:name] %></h3>
            <p class="text-sm text-gray-600 mb-3">
              <%= @selected_plan[:credits] ? "#{@selected_plan[:credits]} crédits inclus" : "Abonnement #{@selected_plan[:period]}" %>
            </p>
            <div class="flex justify-between items-baseline">
              <span class="text-gray-600">Prix</span>
              <span class="text-2xl font-bold text-gray-900"><%= @selected_plan[:price] %>€</span>
            </div>
          </div>

          <div class="border-t border-gray-200 pt-4">
            <div class="flex justify-between items-center mb-2">
              <span class="text-gray-600">Sous-total HT</span>
              <span class="text-gray-900"><%= (@selected_plan[:price] / 1.2).round(2) %>€</span>
            </div>
            <div class="flex justify-between items-center mb-4">
              <span class="text-gray-600">TVA (20%)</span>
              <span class="text-gray-900"><%= (@selected_plan[:price] - @selected_plan[:price] / 1.2).round(2) %>€</span>
            </div>
            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
              <span class="font-semibold text-gray-900">Total TTC</span>
              <span class="text-2xl font-bold text-gray-900"><%= @selected_plan[:price] %>€</span>
            </div>
          </div>

          <!-- Security Badges -->
          <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="flex items-center gap-3 text-sm text-gray-500">
              <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
              </svg>
              <span>Paiement 100% sécurisé</span>
            </div>
            <div class="flex items-center gap-3 text-sm text-gray-500 mt-2">
              <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
              <span>Données chiffrées SSL</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Form -->
      <div class="lg:col-span-3">
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h2 class="text-xl font-bold text-gray-900 mb-6">Informations de paiement</h2>
          
          <%= form_with url: checkout_process_payment_path, method: :post, local: true, class: "space-y-6" do |f| %>
            <%= hidden_field_tag :plan, @selected_plan[:id] %>
            
            <!-- Billing Info -->
            <div>
              <h3 class="text-sm font-semibold text-gray-900 mb-4">Informations de facturation</h3>
              <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2 sm:col-span-1">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Prénom</label>
                  <input type="text" name="billing[first_name]" value="<%= current_user.first_name %>" required
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="col-span-2 sm:col-span-1">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                  <input type="text" name="billing[last_name]" value="<%= current_user.last_name %>" required
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input type="email" name="billing[email]" value="<%= current_user.email %>" required
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="col-span-2">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Entreprise (optionnel)</label>
                  <input type="text" name="billing[company]" placeholder="Nom de l'entreprise"
                         class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
              </div>
            </div>

            <!-- Card Info -->
            <div>
              <h3 class="text-sm font-semibold text-gray-900 mb-4">Carte bancaire</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Numéro de carte</label>
                  <div class="relative">
                    <input type="text" name="card[number]" placeholder="1234 5678 9012 3456" required
                           class="w-full px-4 py-2 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 flex gap-1">
                      <svg class="h-6 w-auto" viewBox="0 0 36 24" fill="none">
                        <rect width="36" height="24" rx="4" fill="#1A1F71"/>
                        <path d="M15.8 16.5L17.3 8h2.3l-1.5 8.5h-2.3zM24.2 8.2c-.5-.2-1.2-.4-2.1-.4-2.3 0-4 1.2-4 2.9 0 1.3 1.1 2 2 2.4.9.4 1.2.7 1.2 1.1 0 .6-.7.9-1.4.9-.9 0-1.4-.1-2.2-.5l-.3-.1-.3 2c.5.3 1.5.5 2.6.5 2.5 0 4.1-1.2 4.1-3 0-1-.6-1.8-2-2.4-.8-.4-1.3-.7-1.3-1.1 0-.4.4-.8 1.3-.8.8 0 1.3.2 1.8.4l.2.1.3-2z" fill="#fff"/>
                      </svg>
                      <svg class="h-6 w-auto" viewBox="0 0 36 24" fill="none">
                        <rect width="36" height="24" rx="4" fill="#FF5F00"/>
                        <circle cx="14" cy="12" r="7" fill="#EB001B"/>
                        <circle cx="22" cy="12" r="7" fill="#F79E1B"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M18 17.9a7 7 0 000-11.8 7 7 0 010 11.8z" fill="#FF5F00"/>
                      </svg>
                    </div>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date d'expiration</label>
                    <input type="text" name="card[expiry]" placeholder="MM/AA" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">CVC</label>
                    <input type="text" name="card[cvc]" placeholder="123" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                </div>
              </div>
            </div>

            <!-- Terms -->
            <div class="flex items-start gap-3">
              <input type="checkbox" id="terms" name="accept_terms" required
                     class="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
              <label for="terms" class="text-sm text-gray-600">
                J'accepte les 
                <%= link_to "conditions générales d'utilisation", terms_path, class: "text-blue-600 hover:text-blue-700 underline", target: "_blank" %>
                et la 
                <%= link_to "politique de confidentialité", privacy_path, class: "text-blue-600 hover:text-blue-700 underline", target: "_blank" %>.
              </label>
            </div>

            <!-- Submit -->
            <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
              </svg>
              Payer <%= @selected_plan[:price] %>€
            </button>
            
            <p class="text-xs text-center text-gray-500">
              En validant, vous serez débité de <%= @selected_plan[:price] %>€. 
              <% if @selected_plan[:period] == 'mois' %>
                Renouvellement automatique chaque mois.
              <% elsif @selected_plan[:period] == 'an' %>
                Renouvellement automatique chaque année.
              <% end %>
              Annulable à tout moment.
            </p>
          <% end %>
        </div>

        <!-- Stripe Badge -->
        <div class="mt-6 text-center">
          <p class="text-xs text-gray-500 flex items-center justify-center gap-2">
            <svg class="h-6 w-auto" viewBox="0 0 60 25" fill="none">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M60 12.5c0-3.9-1.9-7-5.5-7-3.7 0-5.8 3.1-5.8 6.9 0 4.6 2.6 6.9 6.3 6.9 1.8 0 3.2-.4 4.2-1v-3c-1 .5-2.2.8-3.6.8-1.4 0-2.7-.5-2.9-2.2h7.2c0-.2.1-1 .1-1.4zm-7.2-1.5c0-1.6 1-2.3 1.9-2.3.9 0 1.8.7 1.8 2.3h-3.7zm-9.5-5.5c-1.5 0-2.4.7-2.9 1.2l-.2-1h-3.2v17.5l3.7-.8v-4.2c.6.4 1.4 1 2.7 1 2.7 0 5.2-2.2 5.2-7 0-4.4-2.5-6.7-5.3-6.7zm-.9 10.3c-.9 0-1.4-.3-1.8-.7v-5.7c.4-.5 1-.8 1.8-.8 1.4 0 2.3 1.5 2.3 3.6 0 2.1-1 3.6-2.3 3.6zm-11-3.3c0-.5.4-.7 1.1-.7.9 0 2.1.3 3 .8V9.2c-1-.4-2-.5-3-.5-2.5 0-4.1 1.3-4.1 3.4 0 3.4 4.6 2.8 4.6 4.3 0 .6-.5.8-1.2.8-1 0-2.4-.4-3.4-1v3.5c1.2.5 2.3.7 3.4.7 2.5 0 4.3-1.3 4.3-3.5-.1-3.6-4.7-3-4.7-4.4zm-8 6.8h3.7V5.8l-3.7.8v12.7zm-3.7-14.2l-3.6.8v10.3c0 1.9 1.4 3.3 3.3 3.3.7 0 1.4-.1 2.1-.3V16c-.4.1-2.5.6-2.5-1v-5.9h2.5V5.8h-2.5l.7-2.7zm-12 5.5c-.6-1-1.5-1.1-2-1.1-1.7 0-3.3 1.7-3.3 4.6 0 3.7 2.1 4.6 3.4 4.6.4 0 1.2-.1 1.9-.9l.2.7h3.1V0L.3.8v7.8z" fill="#6772E5"/>
            </svg>
            Paiement sécurisé par Stripe
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
