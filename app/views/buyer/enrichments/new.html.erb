<% content_for :title, "Ajouter un document - #{@listing.title} - Idéal Reprise" %>
<% content_for :page_title, "Ajouter un document" %>

<div class="max-w-3xl mx-auto space-y-6">
  <%= link_to buyer_deal_path(@buyer_profile.deals.find_by(listing: @listing)), class: "inline-flex items-center gap-2 text-gray-600 hover:text-gray-900" do %>
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
    </svg>
    Retour au dossier
  <% end %>

  <div>
    <h1 class="text-2xl font-bold text-gray-900">Ajouter un document enrichi</h1>
    <p class="text-gray-600 mt-1"><%= @listing.title %></p>
  </div>

  <!-- Info box about seller validation -->
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex gap-3">
      <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div class="flex-1">
        <p class="text-sm text-blue-800">
          <strong>Information :</strong> Les documents que vous ajoutez seront envoyés au cédant pour validation. Les documents validés enrichiront le dossier et amélioreront sa complétude.
        </p>
      </div>
    </div>
  </div>

  <%= form_with model: @enrichment, url: buyer_listing_enrichments_path(@listing), local: true, class: "space-y-6" do |f| %>
    <% if @enrichment.errors.any? %>
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <h3 class="text-sm font-medium text-red-800 mb-2">
          <%= pluralize(@enrichment.errors.count, "erreur") %> <%= @enrichment.errors.count > 1 ? 'ont empêché' : 'a empêché' %> la soumission :
        </h3>
        <ul class="list-disc list-inside text-sm text-red-700">
          <% @enrichment.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Catégorie document (11 catégories) -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Catégorie du document *</h3>
      <%= f.select :document_category, 
          options_for_select([
            ['Bilan N-1', 'balance_n1'],
            ['Bilan N-2', 'balance_n2'],
            ['Bilan N-3', 'balance_n3'],
            ['Organigramme', 'org_chart'],
            ['Liasse fiscale', 'tax_return'],
            ['Compte de résultat', 'income_statement'],
            ['Liste véhicules et matériel lourd re-finançable', 'vehicle_list'],
            ['Bail', 'lease'],
            ['Titre de propriété', 'property_title'],
            ['Rapport Scorecard', 'scorecard'],
            ['Autre', 'other']
          ], @enrichment.document_category),
          { include_blank: 'Sélectionnez une catégorie...' },
          class: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-buyer-500 focus:border-buyer-500' %>
    </div>

    <!-- Description -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Description (optionnel)</h3>
      <%= f.text_area :description,
          rows: 3,
          placeholder: "Ajoutez une note ou description pour ce document...",
          class: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-buyer-500 focus:border-buyer-500' %>
    </div>

    <!-- Upload -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Fichier *</h3>
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-buyer-400 transition">
        <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
        <p class="text-gray-700 font-medium mb-1">Sélectionnez votre fichier</p>
        <div class="mt-4">
          <%= f.file_field :document, 
              accept: 'application/pdf,image/*,.doc,.docx,.xls,.xlsx',
              class: 'block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-lg file:border-0
                file:text-sm file:font-semibold
                file:bg-buyer-50 file:text-buyer-700
                hover:file:bg-buyer-100' %>
        </div>
        <p class="text-xs text-gray-500 mt-4">PDF, JPG, PNG, Word, Excel - Max 10 MB</p>
      </div>
    </div>

    <!-- Documents déjà uploadés -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
      <h3 class="text-lg font-bold text-gray-900 mb-4">Documents de cette annonce</h3>
      
      <!-- Documents added by seller -->
      <% if @listing_documents.any? %>
        <div class="mb-4">
          <h4 class="text-sm font-semibold text-gray-700 mb-2">Ajoutés par le cédant</h4>
          <div class="space-y-2">
            <% @listing_documents.each do |doc| %>
              <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                <div class="flex items-center gap-3 flex-1">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-green-900"><%= doc.document_category&.humanize %></div>
                    <div class="text-xs text-green-700"><%= doc.created_at.strftime('%d/%m/%Y') %></div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Documents added by buyer (existing enrichments) -->
      <% if @existing_enrichments.any? %>
        <div>
          <h4 class="text-sm font-semibold text-gray-700 mb-2">Mes documents enrichis</h4>
          <div class="space-y-2">
            <% @existing_enrichments.each do |enrichment| %>
              <div class="flex items-center justify-between p-3 <%= enrichment.approved? ? 'bg-green-50 border-green-200' : enrichment.rejected? ? 'bg-red-50 border-red-200' : 'bg-orange-50 border-orange-200' %> border rounded-lg">
                <div class="flex items-center gap-3 flex-1">
                  <svg class="w-5 h-5 <%= enrichment.approved? ? 'text-green-600' : enrichment.rejected? ? 'text-red-600' : 'text-orange-600' %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <% if enrichment.approved? %>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    <% elsif enrichment.rejected? %>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    <% else %>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    <% end %>
                  </svg>
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium <%= enrichment.approved? ? 'text-green-900' : enrichment.rejected? ? 'text-red-900' : 'text-orange-900' %>">
                      <%= enrichment.category_label %>
                    </div>
                    <div class="text-xs <%= enrichment.approved? ? 'text-green-700' : enrichment.rejected? ? 'text-red-700' : 'text-orange-700' %>">
                      <%= enrichment.created_at.strftime('%d/%m/%Y') %> • 
                      <% if enrichment.approved? %>
                        ✓ Validé
                      <% elsif enrichment.rejected? %>
                        ✗ Rejeté
                      <% else %>
                        ⏳ En attente
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
          
          <div class="mt-3 text-xs text-gray-600 bg-gray-50 p-3 rounded-lg">
            <strong>Note :</strong> Le cédant sera notifié de vos ajouts de documents et pourra les valider. Les documents validés contribueront à la complétude du dossier.
          </div>
        </div>
      <% end %>
    </div>

    <!-- Actions -->
    <div class="flex gap-3">
      <%= link_to buyer_enrichments_path, class: "px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50" do %>
        Annuler
      <% end %>
      <%= f.submit "Soumettre pour validation", class: "flex-1 px-6 py-3 bg-buyer-600 text-white rounded-lg hover:bg-buyer-700 flex items-center justify-center gap-2" %>
    </div>
  <% end %>
</div>
