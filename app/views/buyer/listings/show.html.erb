<% content_for :title, "#{@listing.title} - D√©tail de l'annonce - Id√©al Reprise" %>
<% content_for :page_title, "D√©tail de l'annonce" %>

<div class="max-w-5xl mx-auto space-y-6">
  <%= link_to buyer_listings_path, class: "inline-flex items-center gap-2 text-gray-600 hover:text-gray-900" do %>
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
    </svg>
    Retour aux annonces
  <% end %>

  <!-- Header -->
  <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
    <div class="flex items-start justify-between mb-4">
      <div class="flex-1">
        <div class="flex items-center gap-3 mb-3">
          <h1 class="text-3xl font-bold text-gray-900"><%= @listing.title %></h1>
          <% case @listing.deal_type %>
          <% when 'direct' %>
            <span class="px-3 py-1 rounded-full text-sm font-medium bg-buyer-100 text-buyer-700">‚ö° Deal Direct</span>
          <% when 'ideal_mandate' %>
            <span class="px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-700">üèÜ Mandat Id√©al</span>
          <% when 'partner_mandate' %>
            <span class="px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-700">ü§ù Mandat Partenaire</span>
          <% end %>
          
          <% if @is_exclusive %>
            <span class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700">‚ú® Exclusif</span>
          <% end %>
        </div>
        <p class="text-gray-600">
          <%= @listing.location_department %> (<%= @listing.location_department&.first(2) %>) ‚Ä¢ <%= @listing.industry_sector&.humanize %>
        </p>
        
        <!-- Scorecard Stars -->
        <% if @listing.show_scorecard_stars && @listing.scorecard_stars %>
          <div class="flex items-center gap-2 mt-3">
            <% @listing.scorecard_stars.times do %>
              <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
            <% end %>
            <% (5 - @listing.scorecard_stars).times do %>
              <svg class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
            <% end %>
            <span class="text-sm text-gray-600 ml-2">Score Scorecard: <%= @listing.scorecard_stars %>/5</span>
          </div>
        <% end %>
      </div>
      
      <!-- Completeness -->
      <div class="text-right">
        <div class="text-sm text-gray-600 mb-1">Compl√©tude</div>
        <div class="text-3xl font-bold <%= @listing.completeness_score >= 85 ? 'text-green-600' : 'text-orange-600' %>">
          <%= @listing.completeness_score %>%
        </div>
      </div>
    </div>
  </div>

  <!-- Key Metrics -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
      <div class="text-sm text-gray-600 mb-1">CA annuel</div>
      <div class="text-xl font-bold text-gray-900">
        <%= @listing.annual_revenue ? number_to_currency(@listing.annual_revenue, unit: "‚Ç¨", precision: 0, format: "%n %u") : 'N/A' %>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
      <div class="text-sm text-gray-600 mb-1">Effectif</div>
      <div class="text-xl font-bold text-gray-900"><%= @listing.employee_count || 'N/A' %></div>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
      <div class="text-sm text-gray-600 mb-1">Prix</div>
      <div class="text-xl font-bold text-buyer-600">
        <% if @listing.asking_price %>
          <%= number_to_currency(@listing.asking_price, unit: "‚Ç¨", precision: 0, format: "%n %u") %>
        <% elsif @listing.price_min && @listing.price_max %>
          <%= number_to_currency(@listing.price_min, unit: "‚Ç¨", precision: 0, format: "%n %u") %> - <%= number_to_currency(@listing.price_max, unit: "‚Ç¨", precision: 0, format: "%n %u") %>
        <% else %>
          Sur demande
        <% end %>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-200">
      <div class="text-sm text-gray-600 mb-1">R√©sultat Net</div>
      <div class="text-xl font-bold text-gray-900">
        <%= @listing.net_profit ? number_to_currency(@listing.net_profit, unit: "‚Ç¨", precision: 0, format: "%n %u") : 'N/A' %>
      </div>
    </div>
  </div>

  <!-- Detailed Information -->
  <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
    <h2 class="text-lg font-bold text-gray-900 mb-4">Informations d√©taill√©es</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <div class="text-sm text-gray-600">Secteur</div>
        <div class="font-medium text-gray-900"><%= @listing.industry_sector&.humanize || 'N/A' %></div>
      </div>
      <% if @listing.legal_form %>
        <div>
          <div class="text-sm text-gray-600">Forme juridique</div>
          <div class="font-medium text-gray-900"><%= @listing.legal_form %></div>
        </div>
      <% end %>
      <% if @listing.transfer_horizon %>
        <div>
          <div class="text-sm text-gray-600">Horizon transmission</div>
          <div class="font-medium text-gray-900"><%= @listing.transfer_horizon %></div>
        </div>
      <% end %>
      <% if @listing.transfer_type %>
        <div>
          <div class="text-sm text-gray-600">Type transmission</div>
          <div class="font-medium text-gray-900"><%= @listing.transfer_type&.humanize %></div>
        </div>
      <% end %>
      <% if @listing.company_age %>
        <div>
          <div class="text-sm text-gray-600">Anciennet√©</div>
          <div class="font-medium text-gray-900"><%= @listing.company_age %> ans</div>
        </div>
      <% end %>
      <% if @listing.customer_type %>
        <div>
          <div class="text-sm text-gray-600">Client√®le</div>
          <div class="font-medium text-gray-900"><%= @listing.customer_type&.upcase %></div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Public Description -->
  <% if @listing.description_public.present? %>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
      <h2 class="text-lg font-bold text-gray-900 mb-4">Description</h2>
      <p class="text-gray-700 leading-relaxed whitespace-pre-wrap"><%= @listing.description_public %></p>
    </div>
  <% end %>

  <!-- NDA & Confidential Information Section -->
  <% 
    platform_nda_signed = current_user.nda_signatures.exists?(signature_type: :platform_wide)
    listing_nda_signed = current_user.nda_signatures.exists?(signature_type: :listing_specific, listing_id: @listing.id)
    has_access_to_confidential = platform_nda_signed && listing_nda_signed
  %>

  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <div class="bg-gradient-to-r from-buyer-600 to-purple-600 px-6 py-4">
      <div class="flex items-center gap-3">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        <h2 class="text-lg font-bold text-white">Informations confidentielles</h2>
        <% if has_access_to_confidential %>
          <span class="ml-auto px-3 py-1 bg-green-500 text-white text-sm font-medium rounded-full">
            ‚úì D√©verrouill√©
          </span>
        <% else %>
          <span class="ml-auto px-3 py-1 bg-yellow-400 text-gray-900 text-sm font-medium rounded-full">
            üîí Verrouill√©
          </span>
        <% end %>
      </div>
    </div>

    <div class="p-6">
      <% if has_access_to_confidential %>
        <!-- Show confidential information -->
        <div class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <% if @listing.location_city.present? %>
              <div>
                <div class="text-sm text-gray-600 mb-1">Ville pr√©cise</div>
                <div class="font-semibold text-gray-900"><%= @listing.location_city %></div>
              </div>
            <% end %>
            
            <% if @listing.website.present? %>
              <div>
                <div class="text-sm text-gray-600 mb-1">Site web</div>
                <div class="font-semibold text-buyer-600">
                  <%= link_to @listing.website, @listing.website, target: "_blank", class: "hover:underline" %>
                </div>
              </div>
            <% end %>
          </div>

          <% if @listing.description_confidential.present? %>
            <div>
              <div class="text-sm text-gray-600 mb-2">Description confidentielle d√©taill√©e</div>
              <div class="text-gray-700 leading-relaxed whitespace-pre-wrap bg-gray-50 p-4 rounded-lg border border-gray-200">
                <%= @listing.description_confidential %>
              </div>
            </div>
          <% end %>

          <!-- Documents section -->
          <% documents = @listing.listing_documents.where(nda_required: true) %>
          <% if documents.any? %>
            <div>
              <div class="text-sm text-gray-600 mb-2">Documents confidentiels</div>
              <div class="space-y-2">
                <% documents.each do |doc| %>
                  <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      <div>
                        <div class="font-medium text-gray-900"><%= doc.title %></div>
                        <div class="text-xs text-gray-600"><%= doc.document_category&.humanize %></div>
                      </div>
                    </div>
                    <span class="text-xs text-gray-500"><%= number_to_human_size(doc.file_size) %></span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Success message -->
          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p class="text-sm text-green-800">
                Vous avez acc√®s aux informations confidentielles de cette annonce apr√®s avoir sign√© l'accord de confidentialit√©. 
                Pour obtenir plus d'informations (coordonn√©es compl√®tes), contactez le vendeur via votre CRM apr√®s r√©servation.
              </p>
            </div>
          </div>
        </div>
      <% elsif !platform_nda_signed %>
        <!-- Need to sign platform NDA first -->
        <div class="text-center py-8">
          <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Accord de confidentialit√© requis</h3>
          <p class="text-gray-600 mb-6 max-w-md mx-auto">
            Pour acc√©der aux informations confidentielles (nom, adresse, contacts, documents), 
            vous devez d'abord signer l'accord de confidentialit√© plateforme.
          </p>
          <%= link_to buyer_nda_path, class: "inline-flex items-center gap-2 px-6 py-3 bg-buyer-600 text-white rounded-lg hover:bg-buyer-700 transition font-medium" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
            Signer l'accord de confidentialit√©
          <% end %>
        </div>
      <% else %>
        <!-- Platform NDA signed, need listing-specific NDA -->
        <div class="space-y-6">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
              <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div class="flex-1">
                <p class="text-sm font-semibold text-blue-900 mb-1">Une derni√®re √©tape</p>
                <p class="text-sm text-blue-800">
                  Vous devez signer un accord de confidentialit√© sp√©cifique pour cette annonce afin d'acc√©der 
                  aux informations confidentielles (nom exact, adresse, contacts).
                </p>
              </div>
            </div>
          </div>

          <%= form_with url: buyer_listing_listing_ndas_path(@listing), method: :post, local: true do |f| %>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-4">
              <h4 class="font-semibold text-gray-900 mb-3">Accord de confidentialit√© - Annonce #<%= @listing.id %></h4>
              <p class="text-sm text-gray-700 mb-4">
                En signant cet accord, vous vous engagez √† pr√©server la confidentialit√© de toutes les informations 
                relatives √† l'annonce "<%= @listing.title %>", conform√©ment √† l'accord de confidentialit√© plateforme 
                que vous avez d√©j√† accept√©.
              </p>
              
              <div class="text-xs text-gray-600 mb-4">
                <p><strong>Signature enregistr√©e avec :</strong></p>
                <ul class="list-disc pl-5 mt-1 space-y-1">
                  <li>Date : <%= Time.current.strftime("%d/%m/%Y √† %H:%M") %></li>
                  <li>IP : <%= request.remote_ip %></li>
                  <li>Utilisateur : <%= current_user.email %></li>
                </ul>
              </div>

              <label class="flex items-start gap-3 cursor-pointer group mb-4">
                <%= f.check_box :accepted_terms, 
                    { class: "mt-1 w-5 h-5 text-buyer-600 border-gray-300 rounded focus:ring-2 focus:ring-buyer-500", required: true }, 
                    '1', '0' %>
                <span class="text-sm text-gray-700 group-hover:text-gray-900">
                  Je m'engage √† respecter l'accord de confidentialit√© pour cette annonce et √† ne divulguer aucune 
                  information confidentielle √† des tiers sans autorisation pr√©alable.
                </span>
              </label>

              <%= f.submit "‚úçÔ∏è Signer et acc√©der aux informations confidentielles", 
                  class: "w-full px-6 py-3 bg-buyer-600 text-white rounded-lg hover:bg-buyer-700 transition font-medium" %>
            </div>
          <% end %>

          <div class="text-center py-4">
            <svg class="w-12 h-12 text-gray-300 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            <p class="text-sm text-gray-500">
              Les informations confidentielles seront visibles apr√®s signature
            </p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Actions -->
  <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
    <h3 class="text-lg font-bold text-gray-900 mb-4">Actions</h3>
    
    <% if @active_deal&.reserved %>
      <!-- Reserved by current buyer - Show timer and release option -->
      <div class="space-y-4">
        <div class="bg-green-50 border-2 border-green-500 rounded-lg p-4">
          <div class="flex items-center justify-between mb-4">
            <div>
              <div class="flex items-center gap-2 mb-2">
                <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span class="font-semibold text-green-800">R√©serv√©e par vous</span>
              </div>
              <div class="text-sm text-green-700">
                √âtape: <span class="font-medium"><%= deal_stage_name(@active_deal.status) %></span>
              </div>
            </div>
            <div>
              <%= render 'buyer/shared/timer_gauge', deal: @active_deal, size: 'medium' %>
            </div>
          </div>
          
          <%= link_to buyer_deal_path(@active_deal), class: "block w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium text-center mb-2" do %>
            üìä Voir dans le CRM
          <% end %>
          
          <%= link_to release_confirm_buyer_listing_path(@listing), class: "block w-full px-4 py-2 border-2 border-orange-500 text-orange-700 rounded-lg hover:bg-orange-50 transition font-medium text-center" do %>
            üîì Lib√©rer cette r√©servation
          <% end %>
        </div>
      </div>
    <% else %>
      <!-- Not reserved by current buyer -->
      <div class="flex flex-wrap gap-3">
        <% if @is_favorited %>
          <%= button_to unfavorite_buyer_listing_path(@listing), method: :post, class: "flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium" do %>
            üíî Retirer des favoris
          <% end %>
        <% else %>
          <%= button_to favorite_buyer_listing_path(@listing), method: :post, class: "flex-1 px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-medium" do %>
            ‚ù§Ô∏è Ajouter aux favoris
          <% end %>
        <% end %>
        
        <% if @active_deal && !@active_deal.reserved %>
          <div class="flex-1 px-6 py-3 bg-pink-100 border-2 border-pink-500 text-pink-800 rounded-lg font-medium text-center">
            ‚ù§Ô∏è Dans vos favoris (CRM)
          </div>
        <% elsif @listing.status == 'reserved' %>
          <div class="flex-1 px-6 py-3 bg-gray-100 border-2 border-gray-400 text-gray-600 rounded-lg font-medium text-center">
            üîí R√©serv√© par un autre repreneur
          </div>
        <% else %>
          <%= button_to reserve_buyer_listing_path(@listing), method: :post, class: "flex-1 px-6 py-3 bg-buyer-600 text-white rounded-lg hover:bg-buyer-700 transition font-medium" do %>
            üîí R√©server cette annonce
          <% end %>
        <% end %>
      </div>
      
      <div class="mt-4 p-4 bg-buyer-50 border border-buyer-200 rounded-lg">
        <p class="text-sm text-buyer-800">
          <% if @listing.status == 'reserved' %>
            <strong>Cette annonce est r√©serv√©e par un autre repreneur.</strong> Vous pouvez l'ajouter √† vos favoris pour √™tre notifi√© si elle redevient disponible.
          <% else %>
            <strong>Note:</strong> Apr√®s r√©servation, vous acc√©derez aux informations confidentielles (nom exact, adresse, contacts, documents) et l'annonce entrera automatiquement dans votre pipeline CRM avec un timer.
          <% end %>
        </p>
      </div>
    <% end %>
  </div>
</div>
