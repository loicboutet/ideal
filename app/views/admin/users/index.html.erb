<div class="min-h-screen bg-gray-50">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Utilisateurs</h1>
          <p class="text-gray-600 mt-1">Gestion de tous les utilisateurs</p>
        </div>
        <%= link_to new_admin_user_path, class: "inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors" do %>
          <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          Nouvel utilisateur
        <% end %>
      </div>

      <!-- Search and Filters -->
      <%= form_with url: admin_users_path, method: :get, class: "flex flex-wrap gap-4 items-center" do |f| %>
        <!-- Search -->
        <div class="flex-1 min-w-[300px]">
          <div class="relative">
            <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <%= f.text_field :search, 
              value: params[:search],
              placeholder: "Rechercher...",
              class: "w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" %>
          </div>
        </div>

        <!-- Role Filter -->
        <%= f.select :role,
          options_for_select([
            ['Tous les rôles', 'all'],
            ['Admin', 'admin'],
            ['Vendeur', 'seller'],
            ['Repreneur', 'buyer'],
            ['Partenaire', 'partner']
          ], params[:role] || 'all'),
          {},
          class: "px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" %>

        <!-- Status Filter -->
        <%= f.select :status,
          options_for_select([
            ['Tous les statuts', 'all'],
            ['Actif', 'active'],
            ['Suspendu', 'suspended'],
            ['En attente', 'pending']
          ], params[:status] || 'all'),
          {},
          class: "px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" %>

        <%= f.submit "Filtrer", class: "px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors" %>
        
        <%= link_to admin_users_path, class: "inline-flex items-center gap-2 px-6 py-2 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Effacer les filtres
        <% end %>
      <% end %>
    </div>

    <!-- Users Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Utilisateur</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rôle</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inscription</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @users.each do |user| %>
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <div class="h-10 w-10 rounded-full <%= role_color(user.role) %> flex items-center justify-center text-white font-semibold">
                      <%= user_initials(user) %>
                    </div>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">
                      <%= user.full_name %>
                    </div>
                    <% if user.company_name.present? %>
                      <div class="text-sm text-gray-500"><%= user.company_name %></div>
                    <% end %>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <%= role_badge(user.role) %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <%= user.email %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <%= l(user.created_at, format: :short) %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <%= status_badge(user.status) %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end gap-2">
                  <%= link_to admin_user_path(user), class: "text-gray-600 hover:text-purple-600" do %>
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  <% end %>
                  <%= link_to edit_admin_user_path(user), class: "text-gray-600 hover:text-purple-600" do %>
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                  <% end %>
                </div>
              </td>
            </tr>
            <% if @stealth_mode %>
              <tr class="bg-gray-50 border-t border-gray-200">
                <td colspan="6" class="px-6 py-4">
                  <div class="text-xs font-semibold text-gray-700 mb-2 uppercase">Subscription Information:</div>
                  <% if user.subscriptions.any? %>
                    <pre class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto text-xs font-mono"><%= JSON.pretty_generate(
                      user.subscriptions.map do |subscription|
                        {
                          id: subscription.id,
                          plan_type: subscription.plan_type,
                          status: subscription.status,
                          amount: subscription.amount_in_euros,
                          currency: 'EUR',
                          period_start: subscription.period_start&.iso8601,
                          period_end: subscription.period_end&.iso8601,
                          stripe_subscription_id: subscription.stripe_subscription_id,
                          stripe_customer_id: subscription.stripe_customer_id,
                          cancel_at_period_end: subscription.cancel_at_period_end,
                          created_at: subscription.created_at.iso8601,
                          updated_at: subscription.updated_at.iso8601
                        }
                      end
                    ) %></pre>
                  <% else %>
                    <div class="text-sm text-gray-500 italic">No subscriptions found</div>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>

      <% if @users.empty? %>
        <div class="text-center py-12">
          <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun utilisateur trouvé</h3>
          <p class="mt-1 text-sm text-gray-500">Commencez par créer un nouvel utilisateur.</p>
          <div class="mt-6">
            <%= link_to "Créer un utilisateur", new_admin_user_path, class: "inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Pagination -->
    <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6 mt-6 rounded-lg shadow">
      <div class="flex-1 flex justify-between sm:hidden">
        <% if @users.prev_page %>
          <%= link_to admin_users_path(page: @users.prev_page, search: params[:search], role: params[:role], status: params[:status]), class: "relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" do %>
            Précédent
          <% end %>
        <% else %>
          <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-400 bg-gray-50 cursor-not-allowed">
            Précédent
          </span>
        <% end %>
        <% if @users.next_page %>
          <%= link_to admin_users_path(page: @users.next_page, search: params[:search], role: params[:role], status: params[:status]), class: "ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" do %>
            Suivant
          <% end %>
        <% else %>
          <span class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-400 bg-gray-50 cursor-not-allowed">
            Suivant
          </span>
        <% end %>
      </div>
      <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-gray-700">
            Affichage de <span class="font-medium"><%= @users.offset_value + 1 %></span> à <span class="font-medium"><%= [@users.offset_value + @users.count, @users.total_count].min %></span> sur <span class="font-medium"><%= @users.total_count %></span> résultats
          </p>
        </div>
        <div>
          <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
            <% if @users.prev_page %>
              <%= link_to admin_users_path(page: @users.prev_page, search: params[:search], role: params[:role], status: params[:status]), class: "relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" do %>
                <span class="sr-only">Précédent</span>
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
              <% end %>
            <% else %>
              <span class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-gray-50 text-sm font-medium text-gray-300 cursor-not-allowed">
                <span class="sr-only">Précédent</span>
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
              </span>
            <% end %>
            
            <% page_start = [1, @users.current_page - 1].max %>
            <% page_end = [page_start + 2, @users.total_pages].min %>
            <% page_start = [page_end - 2, 1].max if page_end - page_start < 2 %>
            
            <% (page_start..page_end).each do |page| %>
              <% if page == @users.current_page %>
                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-purple-50 text-sm font-medium text-purple-600"><%= page %></span>
              <% else %>
                <%= link_to page, admin_users_path(page: page, search: params[:search], role: params[:role], status: params[:status]), class: "relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50" %>
              <% end %>
            <% end %>
            
            <% if @users.next_page %>
              <%= link_to admin_users_path(page: @users.next_page, search: params[:search], role: params[:role], status: params[:status]), class: "relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" do %>
                <span class="sr-only">Suivant</span>
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              <% end %>
            <% else %>
              <span class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-gray-50 text-sm font-medium text-gray-300 cursor-not-allowed">
                <span class="sr-only">Suivant</span>
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </span>
            <% end %>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>
