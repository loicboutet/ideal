<% content_for :title, "Timers expirés - Admin - Idéal Reprise" %>

<div class="space-y-6">
  <!-- Back Link -->
  <%= link_to admin_root_path, class: "inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-4" do %>
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
    </svg>
    Retour au centre opérationnel
  <% end %>

  <!-- Header -->
  <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
    <div class="flex items-center gap-3 mb-2">
      <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h1 class="text-2xl font-bold text-gray-900">Timers de réservation expirés</h1>
    </div>
    <p class="text-gray-600">
      Ces transactions ont dépassé leur limite de temps et devraient être libérées automatiquement pour revenir au pool disponible.
    </p>
  </div>

  <!-- Stats Summary -->
  <div class="bg-red-50 border border-red-200 rounded-lg p-4">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-3xl font-bold text-red-900"><%= @deals.total_count %></div>
        <div class="text-sm text-gray-600 mt-1">Transactions avec timer expiré</div>
      </div>
      <svg class="w-12 h-12 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
  </div>

  <!-- Deals Table -->
  <% if @deals.any? %>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Annonce
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Repreneur
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Statut
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Réservé le
              </th>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Expiré depuis
              </th>
              <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @deals.each do |deal| %>
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                  <div class="flex items-center">
                    <div>
                      <div class="text-sm font-medium text-gray-900">
                        <%= deal.listing.title %>
                      </div>
                      <div class="text-sm text-gray-500">
                        <%= deal.listing.location_department %>
                      </div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">
                    <%= deal.buyer_profile.user.email %>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <%= deal_status_badge(deal.status) %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-500">
                    <%= deal.reserved_at ? time_ago_in_words(deal.reserved_at) + ' ago' : 'N/A' %>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <% if deal.reserved_until %>
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <span class="text-sm font-medium text-red-600">
                        <%= time_ago_in_words(deal.reserved_until) %>
                      </span>
                    </div>
                  <% else %>
                    <span class="text-sm text-gray-400">N/A</span>
                  <% end %>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <%= link_to 'Voir', admin_deal_path(deal), class: 'text-admin-600 hover:text-admin-900 mr-3' if defined?(admin_deal_path) %>
                  <span class="text-gray-400">Libération auto en attente</span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div class="flex items-center justify-between">
      <div class="text-sm text-gray-700">
        Affichage de <span class="font-medium"><%= @deals.offset_value + 1 %></span> à 
        <span class="font-medium"><%= [@deals.offset_value + @deals.size, @deals.total_count].min %></span> sur 
        <span class="font-medium"><%= @deals.total_count %></span> résultats
      </div>
      <%= paginate @deals, theme: 'twitter-bootstrap-4' %>
    </div>

    <!-- Info Box -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <div class="flex gap-3">
        <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div class="text-sm text-blue-900">
          <p class="font-medium mb-1">Note sur la libération automatique :</p>
          <p>
            Ces transactions devraient normalement être libérées automatiquement par le système. 
            Si elles apparaissent ici, cela peut indiquer que le processus de background job 
            n'est pas en cours d'exécution ou nécessite une intervention manuelle.
          </p>
        </div>
      </div>
    </div>
  <% else %>
    <div class="bg-white rounded-lg shadow-sm p-12 text-center border border-gray-200">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun timer expiré</h3>
      <p class="mt-1 text-sm text-gray-500">
        Toutes les réservations actives sont dans les délais ou ont été correctement libérées.
      </p>
    </div>
  <% end %>
</div>
