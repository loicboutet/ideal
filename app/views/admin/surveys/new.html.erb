<% content_for :title, "Nouveau questionnaire - Administration - Idéal Reprise" %>

<!-- New Survey Form -->
<div class="max-w-4xl mx-auto space-y-6">
  <!-- Header -->
  <div class="flex items-center gap-4">
    <%= link_to admin_surveys_path, class: "text-gray-600 hover:text-gray-900" do %>
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    <% end %>
    <div>
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Nouveau questionnaire</h1>
      <p class="text-gray-600 mt-1">Créez un questionnaire de satisfaction ou de développement</p>
    </div>
  </div>

  <%= form_with model: @survey, url: admin_surveys_path, class: "space-y-6", data: { controller: "survey-builder" } do |f| %>
    <!-- Survey Type Selection -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
      <h2 class="text-lg font-bold text-gray-900 mb-4">Type de questionnaire</h2>
      
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none hover:border-admin-500 transition">
          <%= f.radio_button :survey_type, :satisfaction, class: "sr-only", data: { action: "change->survey-builder#toggleType", "survey-builder-target": "typeInput" } %>
          <span class="flex flex-1">
            <span class="flex flex-col">
              <span class="block text-sm font-medium text-gray-900 mb-2">
                <svg class="w-6 h-6 inline text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                </svg>
                Satisfaction
              </span>
              <span class="block text-sm text-gray-500">Simple questionnaire avec note de 1 à 5 étoiles et un commentaire optionnel</span>
            </span>
          </span>
        </label>

        <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none hover:border-admin-500 transition">
          <%= f.radio_button :survey_type, :development, class: "sr-only", data: { action: "change->survey-builder#toggleType", "survey-builder-target": "typeInput" } %>
          <span class="flex flex-1">
            <span class="flex flex-col">
              <span class="block text-sm font-medium text-gray-900 mb-2">
                <svg class="w-6 h-6 inline text-admin-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                Développement
              </span>
              <span class="block text-sm text-gray-500">Questionnaire personnalisé avec plusieurs questions de différents types</span>
            </span>
          </span>
        </label>
      </div>
    </div>

    <!-- Survey Details -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
      <h2 class="text-lg font-bold text-gray-900 mb-4">Détails du questionnaire</h2>
      
      <div class="space-y-4">
        <div>
          <%= f.label :title, "Titre", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_field :title, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-admin-500", placeholder: "Ex: Enquête de satisfaction Q4 2025" %>
        </div>

        <div>
          <%= f.label :description, "Description (optionnel)", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_area :description, rows: 3, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-admin-500", placeholder: "Décrivez le but de ce questionnaire..." %>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <%= f.label :starts_at, "Date de début (optionnel)", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.datetime_local_field :starts_at, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-admin-500" %>
          </div>

          <div>
            <%= f.label :ends_at, "Date de fin (optionnel)", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.datetime_local_field :ends_at, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-admin-500" %>
          </div>
        </div>

        <div class="flex items-center">
          <label class="flex items-center cursor-pointer">
            <%= f.check_box :active, class: "rounded border-gray-300 text-admin-600 focus:ring-admin-500 mr-2" %>
            <span class="text-sm font-medium text-gray-900">Activer le questionnaire immédiatement</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Questions Section (Only for Development surveys) -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200" data-survey-builder-target="questionsSection" style="display: none;">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-gray-900">Questions</h2>
        <button type="button" class="inline-flex items-center px-3 py-1.5 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" data-action="click->survey-builder#addQuestion">
          <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
          Ajouter une question
        </button>
      </div>
      
      <div data-survey-builder-target="questionsList" class="space-y-4">
        <!-- Questions will be added here dynamically -->
      </div>
      
      <%= f.hidden_field :questions, data: { "survey-builder-target": "questionsInput" } %>
    </div>

    <!-- Recipients Section (Admin Message) -->
    <%= fields_for :admin_message, @admin_message do |am| %>
      <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
        <h2 class="text-lg font-bold text-gray-900 mb-4">Destinataires</h2>
        
        <div class="space-y-4">
          <div>
            <%= am.label :subject, "Objet du message", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= am.text_field :subject, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-admin-500", placeholder: "Ex: Votre avis compte !" %>
          </div>

          <div>
            <%= am.label :body, "Message d'accompagnement", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= am.text_area :body, rows: 4, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-admin-500", placeholder: "Votre message aux destinataires..." %>
          </div>

          <div>
            <%= am.label :target_role, "Envoyer à", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= am.select :target_role, 
                options_for_select([
                  ['Tous les utilisateurs', 'all_roles'],
                  ['Vendeurs uniquement', 'seller'],
                  ['Acheteurs uniquement', 'buyer'],
                  ['Partenaires uniquement', 'partner']
                ], 'all_roles'),
                {},
                class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-admin-500" %>
          </div>

          <%= am.hidden_field :message_type, value: 'survey' %>
        </div>
      </div>
    <% end %>

    <!-- Actions -->
    <div class="flex items-center justify-end gap-3 pt-4">
      <%= link_to "Annuler", admin_surveys_path, class: "px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-admin-500 transition" %>
      <%= f.submit "Créer et envoyer le questionnaire", class: "px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-admin-600 hover:bg-admin-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-admin-500 transition" %>
    </div>
  <% end %>
</div>
